import os
import pandas as pd
import plotly.graph_objects as go
import plotly.io as pio
import plotly.colors
import numpy as np

# Read the CSV file
non_community_0_df = pd.read_csv('rep_n_relax_non_0_df.csv')

# Replace NaN and infinite values in 'overall_SNPs' with 0
non_community_0_df['overall_SNPs'] = non_community_0_df['overall_SNPs'].replace([np.inf, -np.inf], 0).fillna(0)

# Delete rows where plasmid_1_subcommunity and plasmid_2_subcommunity don't match
non_community_0_df = non_community_0_df[non_community_0_df['plasmid_1_subcommunity'] == non_community_0_df['plasmid_2_subcommunity']]

# Get unique subcommunities
subcommunities = non_community_0_df[['plasmid_1_subcommunity', 'plasmid_2_subcommunity']].melt()['value'].unique()

# Extract unique types from plasmid_1_mobility and plasmid_2_mobility
unique_mobility_types_1 = non_community_0_df['plasmid_1_mobility'].unique()
unique_mobility_types_2 = non_community_0_df['plasmid_2_mobility'].unique()

# Combine the unique types and remove duplicates
unique_mobility_types = list(set(unique_mobility_types_1).union(set(unique_mobility_types_2)))

# Create a color map for the unique mobility types using Plotly's Viridis color palette
colors = plotly.colors.qualitative.Plotly
color_dict = {mobility_type: colors[i % len(colors)] for i, mobility_type in enumerate(unique_mobility_types)}

# Normalize sizes using P1_mobtyper_size (kb) and P2_mobtyper_size (kb)
non_community_0_df['size_1_norm'] = 200 * (non_community_0_df['plasmid_1_mobtyper_size'] - non_community_0_df['plasmid_1_mobtyper_size'].min()) / (non_community_0_df['plasmid_1_mobtyper_size'].max() - non_community_0_df['plasmid_1_mobtyper_size'].min()) + 50
non_community_0_df['size_2_norm'] = 200 * (non_community_0_df['plasmid_2_mobtyper_size'] - non_community_0_df['plasmid_2_mobtyper_size'].min()) / (non_community_0_df['plasmid_2_mobtyper_size'].max() - non_community_0_df['plasmid_2_mobtyper_size'].min()) + 50

# Set output folder
output_folder = 'subcommunity_plot_all_mobility_interactive_5'
os.makedirs(output_folder, exist_ok=True)

# Legend layout settings
legend_layout = dict(x=1.05, y=0.5, bordercolor="Black", borderwidth=1)
right_margin = dict(r=150)

## PLOT 1 ##
# Create the figure for the full range plot
fig = go.Figure()

# Plot all data points for each subcommunity
for _, row in non_community_0_df.iterrows():
    if pd.isna(row['overall_SNPs']) or pd.isna(row['distance']) or pd.isna(row['size_1_norm']) or pd.isna(row['size_2_norm']):
        continue

    hover_text_2 = f"Subcommunity: {row['plasmid_2_subcommunity']}<br>Mobility Type: {row['plasmid_2_mobility']}"
    hover_text_1 = f"Subcommunity: {row['plasmid_1_subcommunity']}<br>Mobility Type: {row['plasmid_1_mobility']}"

    fig.add_trace(go.Scatter(
        x=[row['overall_SNPs']],
        y=[row['distance']],
        mode='markers',
        marker=dict(size=row['size_2_norm'] * 0.1, color=color_dict.get(row['plasmid_2_mobility'], 'grey'), symbol='triangle-up', line=dict(width=1, color='black')),
        name=row['plasmid_2_subcommunity'],
        hovertext=hover_text_2,
        showlegend=True
    ))

    fig.add_trace(go.Scatter(
        x=[row['overall_SNPs']],
        y=[row['distance']],
        mode='markers',
        marker=dict(size=row['size_1_norm'] * 0.1, color=color_dict.get(row['plasmid_1_mobility'], 'grey'), symbol='circle', line=dict(width=1, color='black')),
        name=row['plasmid_1_subcommunity'],
        hovertext=hover_text_1,
        showlegend=True
    ))

# Customize the plot
fig.update_layout(
    title='Scatter Plot of DCJ-indel Distance vs SNP Distance for all Subcommunities',
    xaxis_title='SNP Distance',
    yaxis_title='DCJ-indel Distance',
    legend_title_text='Subcommunities', 
    legend=legend_layout,
    margin=right_margin
)

# Save the full range plot as an HTML file
full_range_html = os.path.join(output_folder, 'all_subcommunities_mobility.html')
pio.write_html(fig, file=full_range_html, auto_open=False)

## PLOT 2 ##
# Create the figure for the limited x-axis plot (SNP Distance ≤ 10)
fig = go.Figure()

# Plot all data points for each subcommunity with limited x-axis
for _, row in non_community_0_df.iterrows():
    if pd.isna(row['overall_SNPs']) or pd.isna(row['distance']) or pd.isna(row['size_1_norm']) or pd.isna(row['size_2_norm']):
        continue

    if row['overall_SNPs'] > 10:
        continue

    hover_text_2 = f"Subcommunity: {row['plasmid_2_subcommunity']}<br>Mobility Type: {row['plasmid_2_mobility']}"
    hover_text_1 = f"Subcommunity: {row['plasmid_1_subcommunity']}<br>Mobility Type: {row['plasmid_1_mobility']}"

    fig.add_trace(go.Scatter(
        x=[row['overall_SNPs']],
        y=[row['distance']],
        mode='markers',
        marker=dict(size=row['size_2_norm'] * 0.1, color=color_dict.get(row['plasmid_2_mobility'], 'grey'), symbol='triangle-up', line=dict(width=1, color='black')),
        name=row['plasmid_2_subcommunity'],
        hovertext=hover_text_2,
        showlegend=True
    ))

    fig.add_trace(go.Scatter(
        x=[row['overall_SNPs']],
        y=[row['distance']],
        mode='markers',
        marker=dict(size=row['size_1_norm'] * 0.1, color=color_dict.get(row['plasmid_1_mobility'], 'grey'), symbol='circle', line=dict(width=1, color='black')),
        name=row['plasmid_1_subcommunity'],
        hovertext=hover_text_1,
        showlegend=True
    ))

# Customize the plot
fig.update_layout(
    title='Scatter Plot of DCJ-indel Distance vs SNP Distance for all Subcommunity Replicons (SNP Distance ≤ 10)',
    xaxis_title='SNP Distance',
    yaxis_title='DCJ-indel Distance',
    xaxis=dict(range=[0, 10]),
    legend_title_text='Subcommunities', 
    legend=legend_layout,
    margin=right_margin
)

# Save the limited x-axis plot as an HTML file
limited_x_html = os.path.join(output_folder, 'all_subcommunities_mobility_50.html')
pio.write_html(fig, file=limited_x_html, auto_open=False)

## PLOT 3 ##
# Create the figure for the limited x-axis plot (SNP Distance ≤ 0.5)
fig = go.Figure()

# Plot all data points for each subcommunity with limited x-axis
for _, row in non_community_0_df.iterrows():
    if pd.isna(row['overall_SNPs']) or pd.isna(row['distance']) or pd.isna(row['size_1_norm']) or pd.isna(row['size_2_norm']):
        continue

    if row['overall_SNPs'] > 0.5:
        continue

    hover_text_2 = f"Subcommunity: {row['plasmid_2_subcommunity']}<br>Mobility Type: {row['plasmid_2_mobility']}"
    hover_text_1 = f"Subcommunity: {row['plasmid_1_subcommunity']}<br>Mobility Type: {row['plasmid_1_mobility']}"

    fig.add_trace(go.Scatter(
        x=[row['overall_SNPs']],
        y=[row['distance']],
        mode='markers',
        marker=dict(size=row['size_2_norm'] * 0.1, color=color_dict.get(row['plasmid_2_mobility'], 'grey'), symbol='triangle-up', line=dict(width=1, color='black')),
        name=row['plasmid_2_subcommunity'],
        hovertext=hover_text_2,
        showlegend=True
    ))

    fig.add_trace(go.Scatter(
        x=[row['overall_SNPs']],
        y=[row['distance']],
        mode='markers',
        marker=dict(size=row['size_1_norm'] * 0.1, color=color_dict.get(row['plasmid_1_mobility'], 'grey'), symbol='circle', line=dict(width=1, color='black')),
        name=row['plasmid_1_subcommunity'],
        hovertext=hover_text_1,
        showlegend=True
    ))

# Customize the plot
fig.update_layout(
    title='Scatter Plot of DCJ-indel Distance vs SNP Distance for all Subcommunity Replicons (SNP Distance ≤ 0.5)',
    xaxis_title='SNP Distance',
    yaxis_title='DCJ-indel Distance',
    xaxis=dict(range=[0, 0.5]),
    legend_title_text='Subcommunities', 
    legend=legend_layout,
    margin=right_margin
)

# Save the limited x-axis plot as an HTML file
limited_x_html = os.path.join(output_folder, 'all_subcommunities_mobility_0.5.html')
pio.write_html(fig, file=limited_x_html, auto_open=False)

print(f"Interactive plots have been saved as HTML files in the '{output_folder}' directory.")
